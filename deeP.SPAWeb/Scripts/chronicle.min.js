(function(){"use strict";function s(n){return n instanceof RegExp}function h(n){return n&&n.window===n}function f(n){return n&&n.$evalAsync&&n.$watch}function e(n,r){var a,y,p,u,v,l,c;if(n===r)return{isEqual:!0,unequalVariable:"",stringDiff:!1,o1:n,o2:r};if(n===null||r===null)return{isEqual:!1,unequalVariable:"",stringDiff:!1,o1:n,o2:r};if(n!==n&&r!==r)return{isEqual:!0,unequalVariable:"",stringDiff:!1,o1:n,o2:r};if(a=typeof n,y=typeof r,a==y){if(a=="string"&&n!=r)return{isEqual:!1,unequalVariable:"",stringDiff:!0,o1:n,o2:r};if(a=="object")if(i(n)){if(!i(r))return{isEqual:!1,unequalVariable:"",stringDiff:!1,o1:n,o2:r};if((p=n.length)==r.length){for(l={isEqual:!0,unequalVariable:"",stringDiff:!1,o1:n,o2:r},u=0;u<p;u++)if(c=e(n[u],r[u]),!c.isEqual)if(c.unequalVariable="["+String(u)+"]"+c.unequalVariable,c.stringDiff)l=c;else return c;return l}}else{if(o(n))return{isEqual:o(r)&&n.getTime()==r.getTime(),unequalVariable:"",stringDiff:!1,o1:n,o2:r};if(moment.isMoment(n)&&!moment.isMoment(r)||moment.isMoment(r)&&!moment.isMoment(n))return{isEqual:moment(new Date(n)).isSame(moment(new Date(r))),unequalVariable:"",stringDiff:!1,o1:n,o2:r};if(s(n)&&s(r))return{isEqual:n.toString()==r.toString(),unequalVariable:"",stringDiff:!1,o1:n,o2:r};if(f(n)||f(r)||h(n)||h(r)||i(r))return{isEqual:!1,unequalVariable:"",stringDiff:!1,o1:n,o2:r};v={};l={isEqual:!0,unequalVariable:"",stringDiff:!1,o1:n,o2:r};for(u in n)if(u.charAt(0)!=="$"&&!t(n[u])){if(c=e(n[u],r[u]),!c.isEqual)if(c.unequalVariable="."+String(u)+c.unequalVariable,c.stringDiff)l=c;else return c;v[u]=!0}for(u in r)if(!v.hasOwnProperty(u)&&u.charAt(0)!=="$"&&r[u]!==undefined&&!t(r[u]))return{isEqual:!1,unequalVariable:"",stringDiff:!1,o1:n,o2:r};return l}}return{isEqual:!1,unequalVariable:"",stringDiff:!1,o1:n,o2:r}}function v(n,t){var f,r,i,u,e,s,o;if(n&&t){for(n.length>t.length?(r=n.split(""),f=t.split("")):(f=n.split(""),r=t.split("")),i=0,o=[],e=0;e<f.length&&i<r.length;e++){for(u="";f[e]!=r[i]&&i<r.length;)u+=r[i],i++;u&&o.push(u);f[e]==r[i]&&i++}if(s=e==f.length,i<r.length){for(u="";i<r.length;)u+=r[i],i++;o.push(u)}}else s=!1,o=[];return{areSimilar:s,differences:o}}function y(n){var i=/\s/g,t;if(n.length==1){for(t in n[0])if(n[0].hasOwnProperty(t)&&n[0][t].match(i))return!1}else return!1;return!0}var c=15,p=angular.isDefined,n=angular.isUndefined,t=angular.isFunction,i=angular.isArray,u=angular.isString,l=angular.isObject,o=angular.isDate,w=angular.forEach,r=angular.copy,a=angular.bind;angular.module("Chronicle",[]).service("Chronicle",["$rootScope","$parse",function(o,s){this.record=function(n,t,i,r){return new h(n,t,i,r)};var h=function(t,r,e,o){if(u(t)){if(this.watchVar=t,this.parsedWatchVar=s(t),n(this.parsedWatchVar(r)))throw new Error(t+", the watch variable passed to Chronicle, is not defined in the given scope.");}else throw new Error("Watch variable that is not a string was passed to Chronicle.");if(n(r))throw new Error("Undefined scope passed to Chronicle.");else{if(f(r))this.isScope=!0;else if(l(r))this.isScope=!1;else throw new Error("Incorrect scope type passed to Chronicle.");this.scope=r}if(this.stringHandling=e!==!0&&e!=="true"?!1:!0,this.parsedNoWatchVars=[],i(o))for(var h in o)if(u(o[h])){if(this.parsedNoWatchVars.push(s(o[h])),n(this.parsedNoWatchVars[h](r)))throw new Error(o[h]+", a 'no watch' variable passed to Chronicle, is not defined in the given scope");}else throw new Error("Not all passed 'no watch' variables are in string format");else if(u(o)){if(this.parsedNoWatchVars.push(s(o)),n(this.parsedNoWatchVars[0](r)))throw new Error(o+", the 'no watch' variable passed to Chronicle, is not defined in the given scope");}else if(!n(o))throw new Error("Incorect type for 'no watch' variables");this.archive=[];this.onAdjustFunctions=[];this.onRedoFunctions=[];this.onUndoFunctions=[];this.currArchivePos=null;this.addWatch()};h.prototype.addOnAdjustFunction=function(n){if(t(n))this.onAdjustFunctions.push(n);else throw new Error("Function added to run on adjustment is not a function");};h.prototype.removeOnAdjustFunction=function(n){this.onAdjustFunctions.splice(this.onAdjustFunctions.indexOf(n),1)};h.prototype.addOnUndoFunction=function(n){if(t(n))this.onUndoFunctions.push(n);else throw new Error("Function added to run on undo is not a function");};h.prototype.removeOnUndoFunction=function(n){this.onUndoFunctions.splice(this.onUndoFunctions.indexOf(n),1)};h.prototype.addOnRedoFunction=function(n){if(t(n))this.onRedoFunctions.push(n);else throw new Error("Function added to run on redo is not a function");};h.prototype.removeOnRedoFunction=function(n){this.onRedoFunctions.splice(this.onRedoFunctions.indexOf(n),1)};h.prototype.undo=function(){if(this.canUndo()){this.currArchivePos-=1;this.revert(this.currArchivePos);for(var n=0;n<this.onUndoFunctions.length;n++)this.onUndoFunctions[n]();return!0}return!1};h.prototype.redo=function(){if(this.canRedo()){this.currArchivePos+=1;this.revert(this.currArchivePos);for(var n=0;n<this.onRedoFunctions.length;n++)this.onRedoFunctions[n]();return!0}return!1};h.prototype.revert=function(n){this.parsedWatchVar.assign(this.scope,r(this.archive[n].watchVar));for(var t=0;t<this.parsedNoWatchVars.length;t++)this.parsedNoWatchVars[t].assign(this.scope,r(this.archive[n].noWatchVars[t]))};h.prototype.canRedo=function(){return this.currArchivePos<this.archive.length-1?!0:!1};h.prototype.canUndo=function(){return this.currArchivePos>0?!0:!1};h.prototype.addToArchive=function(){var i=!1,n,r,u,t;this.archive.length?(n=e(this.parsedWatchVar(this.scope),this.archive[this.currArchivePos].watchVar),n.isEqual||(i=!0,r=s(this.watchVar+n.unequalVariable),this.stringHandling&&n.stringDiff&&(t=!1,u=v(n.o1,n.o2),u.areSimilar&&this.archive[this.currArchivePos].parsedUnequalVariable==r&&(t=y(u.differences),typeof s("watchVar"+n.unequalVariable)(this.archive[this.currArchivePos-1])!="string"?t=!1:t&&Math.abs(s("watchVar"+n.unequalVariable)(this.archive[this.currArchivePos-1]).length-s("watchVar"+n.unequalVariable)(this.archive[this.currArchivePos]).length)>=c&&(t=!1))))):i=!0;i&&this.newEntry(t,r)};h.prototype.newEntry=function(n,t){var u={},i,f;for(u.noWatchVars=[],u.parsedUnequalVariable=t,u.watchVar=r(this.parsedWatchVar(this.scope)),i=0;i<this.parsedNoWatchVars.length;i++)u.noWatchVars.push(r(this.parsedNoWatchVars[i](this.scope)));for(this.archive.length-1>this.currArchivePos&&(f=this.archive.length-this.currArchivePos-1,this.archive.splice(this.currArchivePos+1,f)),n&&this.archive.splice(this.currArchivePos,1),this.archive.push(u),this.currArchivePos=this.archive.length-1,i=0;i<this.onAdjustFunctions.length;i++)this.onAdjustFunctions[i]()};h.prototype.addWatch=function(){var n=this;n.cancelWatch=n.isScope?n.scope.$watch(n.watchVar,function(){n.addToArchive.apply(n)},!0):o.$watch(a(n,function(){return n.parsedWatchVar(n.scope)}),function(){n.addToArchive.apply(n)},!0)}}])})();
//# sourceMappingURL=chronicle.min.js.map
